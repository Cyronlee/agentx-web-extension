---
alwaysApply: true
---

## Stack

- pnpm
- WXT
- React
- TypeScript
- Tailwind CSS
- shadcn/ui
- lucide-react

## Structure

```
entrypoints/          # auto-discovered by WXT
  background.ts       # service worker
  content.ts          # page injection
  sidepanel/          # React UI
components/ui/        # shadcn/ui (auto-gen)
hooks/                # use-settings.ts, use-theme.ts
db/                   # IndexedDB layer
  schema.ts           # types (Conversation, Message)
  operations.ts       # CRUD functions
  index.ts            # unified exports
lib/utils.ts          # cn()
assets/tailwind.css   # theme vars
app.config.ts         # runtime config + type augmentation
wxt.config.ts         # manifest generation
.memory/              # AI context (wiki-link format)
```

## Hard Rules

### WXT

- Use `defineBackground()`, `defineContentScript()` wrappers
- Import from `#imports`: `storage`, `browser`, `useAppConfig()`
- NEVER manually edit manifest.json (auto-generated from wxt.config.ts)

### Imports

- `@/` → project root (ALWAYS)
- `#imports` → WXT auto-imports

### Storage (WXT)

```typescript
storage.defineItem<T>('local:key', { fallback: T })
// MUST: type + fallback
// Access: .getValue(), .setValue(), .removeValue()
```

### Database (IndexedDB)

- Schema in `db/schema.ts`, operations in `db/operations.ts`
- Import from `@/db`: types + CRUD functions
- Use `idb` library for IndexedDB operations

### Styling

- Tailwind utilities ONLY: `text-muted-foreground`, `bg-primary`
- Theme: `.dark` class-based
- Full-height: `flex flex-col h-screen`
- Scrollable: `<ScrollArea>` wrapper

### Components

- Add shadcn: `pnpm dlx shadcn@latest add <component>`
- Settings pattern: Label + description + control
- NEVER inline styles

### Types

- Strict mode ENFORCED
- Augment WXT types in `app.config.ts`
- Explicit storage types REQUIRED

### Extension

- Background ↔ Sidepanel: `browser.runtime.sendMessage()`
- Content script: DOM access, isolated context
- NEVER block main thread

### Env

- Prefix: `WXT_*`
- Access: `import.meta.env.WXT_*`
- Type in `app.config.ts` module augmentation

### Quality Gate

- Ensure `pnpm run build` passes after code changes

### Memory

- Update memories after code changes
- `.memory/` with YAML frontmatter: `title`, `tags`, `date`
- `[[wiki-link]]` references
- Maintain `.memory/index.md` as the index of all memories
